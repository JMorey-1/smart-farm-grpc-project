<!DOCTYPE html>
<html>
<head>
    <title>Smart Farm Dashboard</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 30px; }
        th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        h2 { margin-top: 40px; }
        button { padding: 5px 10px; margin-right: 5px; }
    </style>
</head>
<body>
    <h1>Smart Farm Dashboard</h1>

    <!-- Weather Section -->
    <section>
        <h2>Weather Report</h2>
        <% if (weatherData) { %>
            <table>
                <tr><th>Temperature</th><td><%= weatherData.temperature.toFixed(1) %> Â°C</td></tr>
                <tr><th>Humidity</th><td><%= weatherData.humidity.toFixed(1) %> %</td></tr>
                <tr><th>Rainfall</th><td><%= weatherData.rainfall.toFixed(1) %> mm</td></tr>
                <tr><th>Windspeed</th><td><%= weatherData.windspeed.toFixed(1) %> km/h</td></tr>
                <tr><th>Condition</th><td><%= weatherData.condition %></td></tr>
                <% if (weatherData.alert) { %>
                    <tr><th>Alert</th><td style="color: red;"><%= weatherData.alert %></td></tr>
                <% } %>
                <tr><th>Report Time</th><td><%= weatherData.reportTimeFormatted %></td></tr>
            </table>
        <% } else { %>
            <p>No weather data available</p>
        <% } %>
    </section>

    <!-- Irrigation Section -->
    <section>
        <h2>Irrigation</h2>
        <% if (soilMoistureData.length > 0) { %>
            <table>
                <thead>
                    <tr>
                        <th>Greenhouse</th>
                        <th>Soil Moisture (%)</th>
                        <th>Irrigation Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="irrigation-table-body">
                    <% soilMoistureData.forEach(greenhouse => { %>
                        <tr>
                            <td><%= greenhouse.name %></td>
                            <td><%= greenhouse.soilMoisture.toFixed(1) %></td>
                            <td><%= greenhouse.isIrrigating ? "Running" : "Stopped" %></td>
                            <td>
                                <button onclick="startIrrigation('<%= greenhouse.greenhouseId %>')">Start</button>
                                <button onclick="stopIrrigation('<%= greenhouse.greenhouseId %>')">Stop</button>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } else { %>
            <p>No irrigation data available</p>
        <% } %>
    </section>

    <!-- Script for live irrigation updates -->
    <script>
        function fetchIrrigationStatus() {
            fetch('/irrigation-status')
                .then(response => response.json())
                .then(greenhouses => {
                    const tbody = document.querySelector('#irrigation-table-body');
                    tbody.innerHTML = '';

                    greenhouses.forEach(g => {
                        const row = `
                            <tr>
                                <td>${g.name}</td>
                                <td>${g.soilMoisture.toFixed(1)}</td>
                                <td>${g.isIrrigating ? "Running" : "Stopped"}</td>
                                <td>
                                    <button onclick="startIrrigation('${g.greenhouseId}')">Start</button>
                                    <button onclick="stopIrrigation('${g.greenhouseId}')">Stop</button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                })
                .catch(err => console.error('Failed to fetch irrigation status:', err));
        }

        function startIrrigation(greenhouseId) {
            fetch('/start-irrigation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `greenhouseId=${encodeURIComponent(greenhouseId)}`
            })
            .then(response => response.text())
            .then(() => fetchIrrigationStatus())
            .catch(err => console.error('Failed to start irrigation:', err));
        }

        function stopIrrigation(greenhouseId) {
            fetch('/stop-irrigation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `greenhouseId=${encodeURIComponent(greenhouseId)}`
            })
            .then(response => response.text())
            .then(() => fetchIrrigationStatus())
            .catch(err => console.error('Failed to stop irrigation:', err));
        }

        // Auto-refresh every 5 seconds
        setInterval(fetchIrrigationStatus, 5000);
    </script>
</body>
</html>